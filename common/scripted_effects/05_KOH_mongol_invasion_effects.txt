# A wild Genghis Khan appears!
spawn_temujin_character_effect = {
	title:c_khentii.title_province = {
		save_scope_as = temujins_birthplace
	}

	if = {
		limit = {
			AND = {
				character:125501 = {
					is_alive = yes
				}
				title:c_ulaanbaatar.holder = character:125501
			}
		}
		character:125501 = {
			save_scope_as = temujin
		}
		scope:temujin = {
			# Make temporarily immune to disease
			add_character_flag = {
				flag = immune_to_disease
				years = 15
			}
			add_trait = greatest_of_khans
			give_temujin_land_effect = yes
			add_gold = 5000
			add_dread = high_dread
			form_the_mongol_empire_effect = yes
			add_prestige = 25000
			dynasty = {
				add_dynasty_prestige_level = 5
				add_dynasty_prestige = 10000
				add_dynasty_perk = warfare_legacy_1
				add_dynasty_perk = warfare_legacy_2
				add_dynasty_perk = warfare_legacy_3
				add_dynasty_perk = warfare_legacy_4
				if = {
					limit = {
						has_dlc_feature = hybridize_culture
					}
					add_dynasty_perk = ep1_culture_legacy_1
				}
			}
		}
	}
	else = {
		create_character = {
			name = "Temujin" # AKA: Genghis Khan
			location = scope:temujins_birthplace
			template = genghis_khan_character_template
			save_scope_as = temujin
		}
		scope:temujin = {
			# Make temporarily immune to disease
			add_character_flag = {
				flag = immune_to_disease
				years = 15
			}

			add_trait = greatest_of_khans
			give_temujin_land_effect = yes
			add_gold = 5000
			add_dread = high_dread
			spawn_temujins_court_effect = yes
			form_the_mongol_empire_effect = yes
			add_prestige = 25000
			dynasty = {
				add_dynasty_prestige_level = 5
				add_dynasty_prestige = 10000
				add_dynasty_perk = warfare_legacy_1
				add_dynasty_perk = warfare_legacy_2
				add_dynasty_perk = warfare_legacy_3
				add_dynasty_perk = warfare_legacy_4
				if = {
					limit = {
						has_dlc_feature = hybridize_culture
					}
					add_dynasty_perk = ep1_culture_legacy_1
				}
			}
		}
	}

	every_player = {
		trigger_event = mongol_invasion.1002 # Mongol Empire spawned notification
	}
}

make_mongolia_invade_tibet = {
	title:e_mongolia.holder = {
		cleanup_mongolia_effect = yes
		spawn_mongol_troops_effect = yes
		spawn_mongol_successor_state_troops_effect = yes
		spawn_mongol_troops_condensed_effect = yes
		start_wars_for_tibet_effect = yes
		set_character_faith_with_conversion = faith:lamaism
		add_character_modifier = Chinese_reinforcements
		random = {
			chance = 35
			every_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:lamaism
			}
		}
		every_child = {
			set_character_faith_with_conversion = faith:lamaism #Also converts their spouse, children, and parents if applicable.
		}
		every_vassal = { # Muslims abandon Faith.
			limit = {
				NOT = { has_trait = zealous }
			}
			random = {
				chance = 35
				set_character_faith = faith:lamaism
				every_held_title = {
					limit = { tier = tier_county }
					set_county_faith = faith:lamaism
				}
			}
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = title:e_mongolia.holder.culture
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = title:e_mongolia.holder.culture
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = title:e_mongolia.holder.culture
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_warrior_character
			faith = title:e_mongolia.holder.faith
			culture = culture:han
		}
		
		# Spawn some captured Han siege engineers
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_siege_engineer
			faith = faith:shangqing
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_siege_engineer
			faith = faith:shangqing
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_siege_engineer
			faith = faith:shangqing
			culture = culture:han
		}
		create_character = {
			gender_female_chance = temujin_soldier_female_chance
			employer = title:e_mongolia.holder
			template = new_siege_engineer
			faith = faith:shangqing
			culture = culture:han
		}
	}
}

start_wars_for_tibet_effect = {
	save_temporary_scope_as = mongol_conqueror
	# Build a list of potential targets
	get_title = title:c_mazongshan 
	add_prestige = 5000
	every_ruler = {
		limit = {
			any_sub_realm_county = {
				title_province = { geographical_region = world_tibet }
			}
		}
		if = {
			limit = { NOT = { is_in_list = top_liege_targets } }
			add_to_temporary_list = top_liege_targets
		}
	}
	every_in_list = {
		list = top_liege_targets
		save_temporary_scope_as = new_war_target
		primary_title.empire = { save_temporary_scope_as = war_target_title }
		# Declare the war
		scope:mongol_conqueror = {
			start_war = {
				cb = mongol_realm_invasion_war
				target = scope:new_war_target.top_liege
				target_title = scope:war_target_title.empire
			}
		}
	}
}
# All the Kara-Khitai realm
# start_wars_for_chagatai_effect = {
# 	save_temporary_scope_as = mongol_conqueror
# 	# Build a list of potential targets
# 	#get_title = title:c_mazongshan 
# 	add_prestige = 5000
	
# 	if = {
# 		limit = { NOT = { is_in_list = top_liege_targets } }
# 		add_to_temporary_list = top_liege_targets
# 	}

# 	every_in_list = {
# 		list = top_liege_targets
# 		save_temporary_scope_as = new_war_target
# 		primary_title.empire = { save_temporary_scope_as = war_target_title }
# 		# Declare the war
# 		scope:mongol_conqueror = {
# 			start_war = {
# 				cb = mongol_realm_invasion_war
# 				target = scope:new_war_target.top_liege
# 				target_title = scope:war_target_title.empire
# 			}
# 		}
# 	}
# }

cleanup_mongolia_effect = {
	every_sub_realm_county = {
		limit = {
			NOT = {
				title_province = {
					geographical_region = special_mongol_empire_yuan_region
				}
			}
		}
		add_to_temporary_list = mongolia_titles_to_give_away_counties

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = mongol_succession
			add_claim_on_loss = no
		}
		
		every_in_list = {
			list = mongolia_titles_to_give_away_counties

			#Ilkhanate counties
			if = {
				limit = {
					exists = global_var:ilkhanate_handed_out
					title_province = {
						geographical_region = special_mongol_empire_ilkhanate_region
					}
				}
				change_title_holder = {
					holder = title:e_ilkhanate.holder
					change = scope:mongol_succession
				}
			}

			#Golden Horde counties
			else_if = {
				limit = {
					exists = global_var:golden_horde_handed_out
					title_province = {
						geographical_region = special_mongol_empire_golden_horde_region
					}
				}
				change_title_holder = {
					holder = title:e_golden_horde.holder
					change = scope:mongol_succession
				}
			}

			#Chagatai counties
			else_if = {
				limit = {
					exists = global_var:chagatai_handed_out
					title_province = {
						geographical_region = special_mongol_empire_chagatai_region
					}
				}
				change_title_holder = {
					holder = title:e_chagatai.holder
					change = scope:mongol_succession
				}
			}

			#Black Horde counties
			else_if = {
				limit = {
					exists = global_var:black_horde_handed_out
					title_province = {
						geographical_region = special_mongol_empire_black_horde_region
					}
				}
				change_title_holder = {
					holder = title:e_black_horde.holder
					change = scope:mongol_succession
				}
			}
			#White Horde counties
			else_if = {
				limit = {
					exists = global_var:white_horde_handed_out
					title_province = {
						geographical_region = special_mongol_empire_white_horde_region
					}
				}
				change_title_holder = {
					holder = title:e_white_horde.holder
					change = scope:mongol_succession
				}
			}
			#Aarlud Khanate counties
			else_if = {
				limit = {
					exists = global_var:aarlud_khanate_handed_out
					title_province = {
						geographical_region = special_mongol_empire_aarlud_khanate_region
					}
				}
				change_title_holder = {
					holder = title:e_aarlud_khanate.holder
					change = scope:mongol_succession
				}
			}
			#Tögsköl Khanate counties
			else_if = {
				limit = {
					exists = global_var:togskol_khanate_handed_out
					title_province = {
						geographical_region = special_mongol_empire_togskol_khanate_region
					}
				}
				change_title_holder = {
					holder = title:e_togskol_khanate.holder
					change = scope:mongol_succession
				}
			}
			#Baruun Khanate counties
			else = {
				limit = {
					exists = global_var:baruun_khanate_handed_out
					title_province = {
						geographical_region = special_mongol_empire_baruun_khanate_region
					}
				}
				change_title_holder = {
					holder = title:e_baruun_khanate.holder
					change = scope:mongol_succession
				}
			}
		}

		resolve_title_and_vassal_change = scope:mongol_succession

		title:e_mongolia = {
			set_title_name = YUAN
		}
	}
}

spawn_minor_mongol_troops_condensed_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = mongol_event_troops
		levies = {
			value = 1000
		}
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		men_at_arms = {
			type = light_horsemen
			stacks = 5
		}
		location = capital_province
		origin = capital_province
	}
	}