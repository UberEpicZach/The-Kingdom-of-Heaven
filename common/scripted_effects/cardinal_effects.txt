become_cardinal = {
	random_in_global_list = {
		variable = cardinals
		limit = {story_owner = {is_alive = no}}
		make_story_owner = prev
		prev = {
			set_variable = {
				name = cardinal_story
				value = prev
			}
		}
	}
}
become_initial_cardinal = {
	create_story = cardinal_story
}
setup_cardinal_activity = {
	update_preferatus = yes
	title:k_papal_state.holder = {set_designated_heir = global_var:preferatus.story_owner}
	#title:b_vaticano.title_province = {spawn_activity = { owner = global_var:preferatus.story_owner type = cardinal_activity}}
}
update_preferatus = {
	ordered_in_global_list = {
		limit = {exists = this}
		variable = cardinals
		order_by = story_owner.cardinal_to_pope_score
		position = 0
		set_global_variable = {
			name = preferatus
			value = this
		}
		dummy_male = {
			set_variable = {
				name = preferatus
				value = prev
			}
		}
	}
}
select_highest_scoring_cardinal_candidate = {
	ordered_cardinal_candidate_ruler = {
		order_by = bishop_to_cardinal_score
		position = 0
		add_to_list = highest_scoring_cardinal_candidates
	}
	ordered_ruler_with_potential_cardinal = {
		order_by = realm_priest.bishop_to_cardinal_score
		position = 0
		realm_priest = {add_to_list = highest_scoring_cardinal_candidates}
	}
	ordered_in_list = {
		limit = {exists = this}
		list = highest_scoring_cardinal_candidates
		order_by = bishop_to_cardinal_score
		position = 0
		save_scope_as = highest_scoring_cardinal_candidate
	}
	
}
select_highest_scoring_player_cardinal_candidate = {
	ordered_cardinal_candidate_vassal = {
		order_by = bishop_to_cardinal_score
		position = 0
		add_to_list = highest_scoring_player_cardinal_candidates
	}
	if = {
		limit = {exists = realm_priest}
		realm_priest = {add_to_list = highest_scoring_player_cardinal_candidates}
	}
	ordered_in_list = {
		limit = {exists = this}
		list = highest_scoring_player_cardinal_candidates
		order_by = bishop_to_cardinal_score
		position = 0
		save_scope_as = highest_scoring_player_cardinal_candidate
	}
	set_variable = {
		name = cardinal_player_candidate
		value = scope:highest_scoring_player_cardinal_candidate
	}
}
promote_new_cardinal = {
#Scope: The cardinal story to replace the owner of
	#save_scope_as = cardinal_story
	#ordered_cardinal_candidate_ruler = {
	#	order_by = bishop_to_cardinal_score
	#	position = 0
	#	prev = {make_story_owner = prev}
	#}
	#ordered_in_list = {
	#	list = cardinal_candidates
	#}
	select_highest_scoring_cardinal_candidate = yes
	make_story_owner = scope:highest_scoring_cardinal_candidate
	scope:highest_scoring_cardinal_candidate = {
		add_trait = koh_cardinal
		if = {
			limit = {
				exists = var:beneficiary
				var:cardinal_campaign_contribution.compare_value >= {
					value = cardinal_election_beneficiary_reward_threshold_per_tier 
					multiply = var:beneficiary.highest_held_title_tier
				}
			}
			var:beneficiary = {
				add_hook = { type = favor_hook target = prev years = 10 } 
				add_piety = cardinal_election_piety_for_beneficiary
			}
		}
	}
}
predict_new_cardinal = {
	select_highest_scoring_cardinal_candidate = yes
	dummy_male = {
		set_variable = {
			name = predicted_cardinal
			value = scope:highest_scoring_cardinal_candidate
		}
	}
	#ordered_in_list = {
	#	list = cardinal_candidates
	#}
}
#spawn_activity = { owner = X type = Y}

#			prev = {remove_list_variable = {name = cardinals target = prev}}
#		}
#		add_to_variable_list = {
#			name = cardinals
#			target = prev

initialize_random_cardinal = {
	ordered_cardinal_candidate_ruler = {
		order_by = bishop_to_cardinal_score
		position = 0
		#realm_priest = {
		become_initial_cardinal = yes 
		add_piety = 100
		add_trait = koh_cardinal
		#}
	}
}
initialize_nine_random_cardinals = {
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
    initialize_random_cardinal = yes
}
indicate_cardinals = {
	every_in_global_list = {
		variable = cardinals
		story_owner = {add_piety = 1}
	}
}
CardinalsAreCardinals = {
	every_living_cardinal = {
		add_prestige = 1
		add_trait = koh_cardinal
		# if = {
		# 	limit = {
		# 		is_landed = no
		# 	}
		# 	give_nickname = nick_cardinal
		# }
	}
}
update_cardinal_window = {
	update_preferatus = yes
	predict_new_cardinal = yes
	set_variable = {
		name = preferatus_character
		value = global_var:preferatus.story_owner
	}
	clear_variable_list = cardinal_characters
	every_in_global_list = {
		variable = cardinals
		prev = {
			add_to_variable_list = {
				name = cardinal_characters
				target = prev.story_owner
			}
		}
	}
	remove_list_variable = {
		name = cardinal_characters target = global_var:preferatus.story_owner
	}
	every_player = {
		limit = {ruler_has_cardinality_eligible_realm_priest = yes}
		select_highest_scoring_player_cardinal_candidate = yes
	}
}

invest_in_cardinal_effect = {
	save_scope_as = player
	ordered_cardinal_candidate_vassal = {
		order_by = bishop_to_cardinal_score
		position = 0
		add_to_list = highest_scoring_player_cardinal_candidates
	}
	if = {
		limit = {exists = realm_priest}
		realm_priest = {add_to_list = highest_scoring_player_cardinal_candidates}
	}
	ordered_in_list = {
		limit = {exists = this}
		list = highest_scoring_player_cardinal_candidates
		order_by = bishop_to_cardinal_score
		position = 0
		save_scope_as = highest_scoring_player_cardinal_candidate
	}
	set_variable = {
		name = cardinal_player_candidate
		value = scope:highest_scoring_player_cardinal_candidate
	}

	scope:highest_scoring_player_cardinal_candidate = {
		if = {
			limit = {
				NOT = {
					exists = var:cardinal_campaign_contribution
				}
			}
			set_variable = {name = cardinal_campaign_contribution value = 0}
		}
		change_variable = {name = cardinal_campaign_contribution add = cardinal_campaign_contribution_invest_cost}
		scope:player = {remove_short_term_gold = cardinal_campaign_contribution_invest_cost}
	
		update_preferatus = yes
		predict_new_cardinal = yes
		set_variable = {
			name = beneficiary
			value = scope:player
		}
	} 
}

deinvest_in_cardinal_effect = {
	save_scope_as = player
	
	scope:highest_scoring_player_cardinal_candidate = {
		change_variable = {name = cardinal_campaign_contribution subtract = cardinal_campaign_contribution_invest_cost}
		scope:player = { add_gold = cardinal_campaign_contribution_divest_refund }
		update_preferatus = yes
		predict_new_cardinal = yes
		if = {
			limit = {
				var:cardinal_campaign_contribution <= cardinal_campaign_contribution_invest_cost
			} 
			remove_variable = beneficiary
		}
	}
}

# grabbing_characters_for_investiture = {
# 	save_scope_as = employer_liege_guy
# 	primary_title = {
# 		save_scope_as = title_thing
# 		set_variable = {
# 			name = selected_title_for_investiture
# 			value = scope:selected_title_inv
# 		}
# 		clear_variable_list = theocrat_candidates
# 	}
# 	set_variable = {
# 		name = selected_title_for_investiture
# 		value = scope:selected_title_inv
# 	}
# 	every_sibling = {
# 		limit = {
# 			has_education_learning_trigger = yes
# 			is_landed = no
# 			is_female = no
# 			is_adult = yes
# 			NOT = { any_heir_to_title = { exists = this } }
# 		}
# 		save_scope_as = person_thing
# 		scope:title_thing = {
# 			add_to_variable_list = {
# 				name = theocrat_candidates
# 				target = scope:person_thing
# 			}
# 		}
# 	}
# 	every_child = {
# 		limit = {
# 			has_education_learning_trigger = yes
# 			is_landed = no
# 			is_adult = yes
# 			is_female = no
# 			NOT = { any_heir_to_title = { exists = this } }
# 		}
# 		save_scope_as = person_thing
# 		scope:title_thing = {
# 			add_to_variable_list = {
# 				name = theocrat_candidates
# 				target = scope:person_thing
# 			}
# 		}
# 	}
	
# 	every_courtier_or_guest = {
# 		limit = {
# 			OR = {
# 				AND = {
# 					is_councillor_of = scope:employer_liege_guy
# 					has_council_position = councillor_court_chaplain
# 				}
# 				AND = {
# 					NOT = {
# 						AND = {
# 							court_owner = { has_realm_law = male_only_law }
# 							is_female = yes
# 						}
# 						AND = {
# 							court_owner = { has_realm_law = male_preference_law }
# 							is_female = yes
# 						}
# 						AND = {
# 							court_owner = { has_realm_law = female_only_law }
# 							is_female = no
# 						}
# 						AND = {
# 							court_owner = { has_realm_law = female_preference_law }
# 							is_female = no
# 						}
# 						has_variable = theocratic_successor
# 						father = liege_or_court_owner
# 						mother = liege_or_court_owner
# 						primary_spouse = liege_or_court_owner
# 					}
# 					learning >= 7
# 				}
# 			}
# 		}
# 		save_scope_as = person_thing
# 		scope:title_thing = {
# 			add_to_variable_list = {
# 				name = theocrat_candidates
# 				target = scope:person_thing
# 			}
# 		}
# 	}
# }

# investiture_ai = {
# 	grabbing_characters_for_investiture = yes


# 	scope:title_thing = {

# 	}

# 	random_in_list = {
# 		list = theocrat_candidates
# 		save_scope_as = theocratic_candidate_for_ai
# 	}

# 	random_in_list = {
# 		list = theocracy_vassals_for_investiture
# 		limit = {
# 			NOT = { is_in_list = investiture_ai_to_use }
# 		}
# 		save_scope_as = theocratic_vassal_for_ai
# 	}

# 	scope:theocratic_vassal_for_ai = {
# 		primary_title = {
# 			save_scope_as = theocratic_inheritor
# 		}
# 	}

# 	scope:title_inheritor = {
# 		set_variable = {
# 			name = theocratic_successor
# 			value = scope:theocratic_inheritor
# 		}
# 	}
	
# 	scope:theocratic_candidate_for_ai = {
# 		set_variable = {
# 			name = theocratic_successor
# 			value = scope:title_inheritor
# 		}
# 	}
# }